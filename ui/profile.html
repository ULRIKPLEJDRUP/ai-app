<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Personprofil</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; padding: 20px; background:#fafafa; }
    h1 { margin: 0 0 10px; font-size: 22px; }
    p.muted { color:#666; font-size:13px; }
    form { background:#fff; border:1px solid #ddd; padding:20px; max-width:700px; }
    label { display:block; font-size:13px; color:#555; margin-bottom:4px; }
    input, select, textarea { width:100%; padding:8px; margin-bottom:14px; font-size:14px; border:1px solid #ccc; border-radius:4px; }
    textarea { min-height:80px; resize:vertical; }
    button { padding:10px 16px; font-size:14px; cursor:pointer; }
    #status { margin-top:12px; font-size:13px; color:#444; }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    .image-preview { width:140px; height:140px; border:1px solid #ccc; border-radius:8px; background:#f5f5f5; display:flex; align-items:center; justify-content:center; margin-bottom:8px; overflow:hidden; }
    .image-preview img { max-width:100%; max-height:100%; }
    .photos-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(140px,1fr)); gap:12px; }
    .photo-card { border:1px solid #ddd; border-radius:8px; padding:8px; background:#fff; text-align:center; }
    .photo-card img { width:100%; height:140px; object-fit:cover; border-radius:6px; }
    .photo-card button { margin-top:6px; }
    .section { margin-top:20px; }
    .injury-options { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
    .injury-option { border:1px solid #ddd; border-radius:20px; padding:6px 12px; font-size:13px; background:#f5f5f5; display:flex; align-items:center; gap:6px; }
    .injury-option input { width:auto; margin:0; }
  </style>
</head>
<body>

<h1>Personprofil</h1>
<p class="muted">
  Grunddata bruges til at personalisere programmer og mål. Du kan altid opdatere oplysningerne.
</p>

<form id="profileForm">
  <div>
    <label for="username">Brugernavn / ID</label>
    <input type="text" id="username" name="username" placeholder="fx ulrikc" />
  </div>

  <div class="row">
    <div>
      <label for="gender">Køn</label>
      <select id="gender" name="gender">
        <option value="">Vælg…</option>
        <option value="male">Mand</option>
        <option value="female">Kvinde</option>
        <option value="nonbinary">Ikke-binær / andet</option>
      </select>
    </div>
    <div>
      <label for="age">Alder</label>
      <input type="number" id="age" name="age" min="10" max="100" placeholder="år" />
    </div>
  </div>

  <div class="row">
    <div>
      <label for="bodyType">Kropstype</label>
      <select id="bodyType" name="bodyType">
        <option value="">Vælg…</option>
        <option value="ectomorph">Ektomorf (slank)</option>
        <option value="mesomorph">Mesomorf (atletisk)</option>
        <option value="endomorph">Endomorf (kraftig)</option>
      </select>
    </div>
    <div>
      <label for="trainingExperience">Træningserfaring</label>
      <select id="trainingExperience" name="trainingExperience">
        <option value="">Vælg…</option>
        <option value="beginner">Begynder (0-1 år)</option>
        <option value="intermediate">Øvet (1-3 år)</option>
        <option value="advanced">Avanceret (3+ år)</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="weightKg">Vægt (kg)</label>
      <input type="number" step="0.1" id="weightKg" name="weightKg" placeholder="kg" />
    </div>
    <div>
      <label for="heightCm">Højde (cm)</label>
      <input type="number" id="heightCm" name="heightCm" placeholder="cm" />
    </div>
    <div>
      <label for="waistCm">Taljemål (cm)</label>
      <input type="number" id="waistCm" name="waistCm" placeholder="cm" />
    </div>
  </div>

  <div>
    <label for="trainingFrequency">Typisk træningsfrekvens</label>
    <select id="trainingFrequency" name="trainingFrequency">
      <option value="">Vælg…</option>
      <option value="1-2">1-2 gange/uge</option>
      <option value="3-4">3-4 gange/uge</option>
      <option value="5+">5+ gange/uge</option>
    </select>
  </div>

  <div class="section">
    <h3>Profilbillede</h3>
    <div class="image-preview" id="profileImagePreview"></div>
    <input type="file" id="profileImageInput" accept="image/*" />
    <button type="button" id="clearProfileImage">Fjern billede</button>
  </div>

  <div class="section">
    <h3>Progressfotos</h3>
    <div class="photos-grid" id="progressPhotosGrid"></div>
    <div class="row" style="margin-top:10px;">
      <div>
        <label for="progressDate">Dato</label>
        <input type="date" id="progressDate" />
      </div>
      <div>
        <label for="progressFile">Foto</label>
        <input type="file" id="progressFile" accept="image/*" />
      </div>
      <div style="align-self:flex-end;">
        <button type="button" id="addProgressPhoto">Tilføj foto</button>
      </div>
    </div>
  </div>

  <div class="section">
    <h3>Skader eller begrænsninger</h3>
    <p class="muted">Vælg relevante skader/områder og tilføj noter.</p>
    <div class="injury-options" id="injuryOptions"></div>
    <label for="injuryNotes">Noter om skader</label>
    <textarea id="injuryNotes" placeholder="fx tidligere operation, triggerpunkter"></textarea>
  </div>

  <button type="submit">Gem profil</button>
  <div id="status"></div>
</form>

<script>
let profileImagePath = "";
let progressPhotos = [];
let injuryOptionsData = [];

function setStatus(msg) {
  document.getElementById("status").textContent = msg;
}

function fillForm(data) {
  document.getElementById("username").value = data.username || "";
  document.getElementById("gender").value = data.gender || "";
  document.getElementById("age").value = data.age || "";
  document.getElementById("bodyType").value = data.bodyType || "";
  document.getElementById("weightKg").value = data.weightKg || "";
  document.getElementById("heightCm").value = data.heightCm || "";
  document.getElementById("waistCm").value = data.waistCm || "";
  document.getElementById("trainingExperience").value = data.trainingExperience || "";
  document.getElementById("trainingFrequency").value = data.trainingFrequency || "";
  profileImagePath = data.profileImagePath || data.profileImageData || "";
  progressPhotos = Array.isArray(data.progressPhotos)
    ? data.progressPhotos
        .map((p) => ({
          date: p?.date || "",
          path: p?.path || p?.data || "",
        }))
        .filter((p) => p.date && p.path)
    : [];
  renderInjuryOptions(Array.isArray(data.injuries) ? data.injuries : []);
  document.getElementById("injuryNotes").value = data.injuryNotes || "";
  renderProfileImage();
  renderProgressPhotos();
}

async function loadProfile() {
  try {
    setStatus("Loader profil…");
    const res = await fetch("/api/profile");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    fillForm(data || {});
    setStatus("Klar ✅");
  } catch (err) {
    console.error(err);
    setStatus("Kunne ikke hente profil ❌");
  }
}

function renderProfileImage() {
  const preview = document.getElementById("profileImagePreview");
  if (!preview) return;
  if (profileImagePath) {
    preview.innerHTML = `<img src="${profileImagePath}" alt="Profil" />`;
  } else {
    preview.textContent = "Intet billede";
  }
}

function renderProgressPhotos() {
  const grid = document.getElementById("progressPhotosGrid");
  if (!grid) return;
  if (!progressPhotos.length) {
    grid.innerHTML = "<p class='muted'>Ingen fotos endnu</p>";
    return;
  }
  grid.innerHTML = progressPhotos
    .map(
      (p, idx) => `
      <div class="photo-card" data-index="${idx}">
        <strong>${p.date}</strong>
        <img src="${p.path || ""}" alt="Progress ${p.date}" />
        <button type="button" data-action="remove-photo" data-index="${idx}" data-path="${p.path}">Fjern</button>
      </div>
    `
    )
    .join("");
}

function renderInjuryOptions(selected) {
  const container = document.getElementById("injuryOptions");
  if (!container) return;
  if (!injuryOptionsData.length) {
    container.innerHTML = "<span class='muted'>Ingen muskelgrupper tilgængelige</span>";
    return;
  }
  const selectedSet = new Set(selected || []);
  container.innerHTML = injuryOptionsData
    .map((opt) => {
      const checked = selectedSet.has(opt.key) ? "checked" : "";
      return `
        <label class="injury-option">
          <input type="checkbox" name="injuryOption" value="${opt.key}" ${checked} />
          ${opt.label}
        </label>
      `;
    })
    .join("");
}

async function uploadAvatar(file) {
  const res = await fetch("/api/profile/avatar", {
    method: "POST",
    headers: {
      "Content-Type": file.type || "application/octet-stream",
      "X-Filename": file.name || "avatar.jpg",
    },
    body: file,
  });
  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || "Upload fejlede");
  }
  return res.json();
}

async function uploadProgressPhoto(date, file) {
  const url = `/api/profile/progress-photo?date=${encodeURIComponent(date)}`;
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": file.type || "application/octet-stream",
      "X-Filename": file.name || "progress.jpg",
    },
    body: file,
  });
  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || "Upload fejlede");
  }
  return res.json();
}

document.getElementById("profileImageInput").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const result = await uploadAvatar(file);
    profileImagePath = result.path;
    renderProfileImage();
    setStatus("Profilbillede uploadet (husk Gem)");
  } catch (err) {
    console.error(err);
    setStatus("Kunne ikke uploade billede ❌");
  }
});

document.getElementById("clearProfileImage").addEventListener("click", () => {
  if (profileImagePath) {
    fetch(`/api/profile/avatar?path=${encodeURIComponent(profileImagePath)}`, { method: "DELETE" }).catch(() => {});
  }
  profileImagePath = "";
  document.getElementById("profileImageInput").value = "";
  renderProfileImage();
});

document.getElementById("addProgressPhoto").addEventListener("click", async () => {
  const date = document.getElementById("progressDate").value;
  const fileInput = document.getElementById("progressFile");
  const file = fileInput.files?.[0];
  if (!date || !file) {
    setStatus("Vælg dato og foto først");
    return;
  }
  try {
    const uploaded = await uploadProgressPhoto(date, file);
    progressPhotos.push({ date: uploaded.date, path: uploaded.path });
    renderProgressPhotos();
    fileInput.value = "";
    document.getElementById("progressDate").value = "";
    setStatus("Foto uploadet (husk Gem)");
  } catch (err) {
    console.error(err);
    setStatus("Kunne ikke tilføje foto ❌");
  }
});

document.getElementById("progressPhotosGrid").addEventListener("click", (e) => {
  const idx = e.target.dataset?.index;
  const path = e.target.dataset?.path;
  if (e.target.dataset?.action === "remove-photo" && idx !== undefined) {
    if (path) {
      fetch(`/api/profile/progress-photo?path=${encodeURIComponent(path)}`, { method: "DELETE" }).catch(() => {});
    }
    progressPhotos.splice(Number(idx), 1);
    renderProgressPhotos();
    setStatus("Foto fjernet (husk Gem)");
  }
});

document.getElementById("profileForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const selectedInjuries = Array.from(
    document.querySelectorAll('input[name="injuryOption"]:checked')
  ).map((el) => el.value);
  const payload = {
    username: document.getElementById("username").value,
    gender: document.getElementById("gender").value,
    age: document.getElementById("age").value,
    bodyType: document.getElementById("bodyType").value,
    weightKg: document.getElementById("weightKg").value,
    heightCm: document.getElementById("heightCm").value,
    waistCm: document.getElementById("waistCm").value,
    trainingExperience: document.getElementById("trainingExperience").value,
    trainingFrequency: document.getElementById("trainingFrequency").value,
    profileImagePath,
    progressPhotos,
    injuries: selectedInjuries,
    injuryNotes: document.getElementById("injuryNotes").value,
  };
  try {
    setStatus("Gemmer…");
    const res = await fetch("/api/profile", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    if (!res.ok) {
      const msg = await res.text().catch(() => "");
      throw new Error(msg || "Fejl ved gem");
    }
    setStatus("Profil gemt ✅");
  } catch (err) {
    console.error(err);
    setStatus("Kunne ikke gemme profil ❌");
  }
});

async function initProfile() {
  try {
    setStatus("Loader muskelgrupper…");
    const res = await fetch("/api/muscles");
    if (res.ok) {
      const data = await res.json();
      injuryOptionsData = Array.isArray(data) ? data : [];
    } else {
      injuryOptionsData = [];
    }
  } catch {
    injuryOptionsData = [];
  }
  await loadProfile();
}

initProfile();
</script>

</body>
</html>
