<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <title>Muskelgrupper</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:20px; background:#fafafa; }
    h1 { margin:0 0 10px; font-size:22px; }
    p.muted { color:#666; font-size:13px; }
    table { border-collapse:collapse; width:100%; max-width:700px; background:#fff; margin-top:10px; }
    th,td { border:1px solid #ddd; padding:8px 10px; font-size:14px; text-align:left; }
    th { background:#f5f5f5; }
    input { width:100%; padding:6px; font-size:14px; box-sizing:border-box; }
    button { padding:6px 12px; font-size:13px; cursor:pointer; }
    .actions { display:flex; gap:6px; }
    form.inline { display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; margin-top:10px; }
    form.inline label { font-size:12px; color:#555; display:block; margin-bottom:4px; }
    form.inline input { width:auto; min-width:140px; }
    #status { margin-top:12px; font-size:13px; color:#444; }
    .tabs { display:flex; flex-wrap:wrap; gap:8px; margin:0 0 16px; padding:0; list-style:none; }
    .tabs a { text-decoration:none; padding:6px 14px; border:1px solid #cfd8e3; border-radius:18px; font-size:13px; color:#223; background:#fff; }
    .tabs a.active { background:#0b72ff; color:#fff; border-color:#0b72ff; }
    .active-profile { margin:0 0 12px; font-size:13px; color:#333; }
    .active-profile strong { color:#000; }
    body.admin-locked [data-admin-only] { pointer-events:none; }
    [data-admin-toggle] { margin-left:12px; padding:4px 10px; font-size:12px; }
    .admin-disabled { opacity:0.6; }
  </style>
  <script src="/common.js"></script>
</head>
<body>
<nav class="tabs">
  <a href="/rm">RM</a>
  <a href="/equipment">Udstyr</a>
  <a href="/profile">Profil</a>
  <a href="/muscles" class="active">Muskler</a>
  <a href="/vision">Vision</a>
  <a href="/program">Programbygger</a>
  <a href="/programs">Programarkiv</a>
  <a href="/warmup">Opvarmning</a>
  <a href="/execute">Eksekvering</a>
  <a href="/profiles">Profiler</a>
</nav>

<div class="active-profile">
  Aktiv profil: <strong data-active-profile-label>Indlæser…</strong> —
  <a href="/profiles">skift</a>
  <button type="button" data-admin-toggle>Admin-tilstand: låst</button>
</div>
<h1>Muskelgrupper</h1>
<p class="muted">Disse labels bruges til både RM-tabellen og profilen (skade/øvelses-tags). Rediger eller tilføj nye efter behov.</p>

<table>
  <thead>
    <tr>
      <th style="width:150px;">Key</th>
      <th>Label</th>
      <th style="width:150px;">Handling</th>
    </tr>
  </thead>
  <tbody id="muscleRows">
    <tr><td colspan="3">Loader…</td></tr>
  </tbody>
</table>

<form id="addMuscleForm" class="inline">
  <div>
    <label for="muscleKey">Ny key</label>
    <input type="text" id="muscleKey" required placeholder="fx core" data-admin-only="true" />
  </div>
  <div>
    <label for="muscleLabel">Label</label>
    <input type="text" id="muscleLabel" placeholder="Visningsnavn" data-admin-only="true" />
  </div>
  <button type="submit" data-admin-only="true">+ Tilføj / opdater</button>
</form>

<div id="status"></div>

<script>
const {
  ensureActiveProfileId,
  updateActiveProfileBadge,
  syncActiveProfileMeta,
  toggleAdminMode,
  applyAdminState,
  isAdminMode,
} = window.AppState;

ensureActiveProfileId();
updateActiveProfileBadge();
applyAdminState();

const adminToggleBtn = document.querySelector("[data-admin-toggle]");
if (adminToggleBtn) {
  adminToggleBtn.addEventListener("click", () => {
    toggleAdminMode();
    applyAdminState();
  });
}

syncActiveProfileMeta();

let muscleCatalog = [];

function setStatus(msg) {
  document.getElementById("status").textContent = msg;
}

async function loadMuscles() {
  const tbody = document.getElementById("muscleRows");
  if (tbody) tbody.innerHTML = "<tr><td colspan='3'>Loader…</td></tr>";
  try {
    const res = await fetch("/api/muscles");
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    muscleCatalog = Array.isArray(data) ? data : [];
    renderTable();
    setStatus("Klar ✅");
  } catch (err) {
    console.error(err);
    if (tbody) tbody.innerHTML = "<tr><td colspan='3'>Fejl ved hentning</td></tr>";
    setStatus("Kunne ikke hente muskelgrupper ❌");
  }
}

function renderTable() {
  const tbody = document.getElementById("muscleRows");
  if (!tbody) return;
  if (!muscleCatalog.length) {
    tbody.innerHTML = "<tr><td colspan='3'>Ingen muskelgrupper</td></tr>";
    return;
  }
  tbody.innerHTML = muscleCatalog
    .map((item) => `
      <tr data-key="${item.key}">
        <td><input type="text" value="${item.key}" disabled /></td>
        <td><input type="text" value="${item.label || ""}" data-field="label" data-admin-only="true" /></td>
        <td>
          <div class="actions">
            <button type="button" data-action="save" data-key="${item.key}" data-admin-only="true">Gem</button>
            <button type="button" data-action="delete" data-key="${item.key}" data-admin-only="true">Slet</button>
          </div>
        </td>
      </tr>
    `)
    .join("");
  applyAdminState();
}

async function upsertMuscle(payload) {
  const res = await fetch("/api/muscles", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });
  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || "Kunne ikke gemme");
  }
}

async function deleteMuscle(key) {
  const res = await fetch(`/api/muscles/${encodeURIComponent(key)}`, { method: "DELETE" });
  if (!res.ok) {
    const msg = await res.text().catch(() => "");
    throw new Error(msg || "Kunne ikke slette");
  }
}

document.getElementById("addMuscleForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!isAdminMode()) {
    setStatus("Aktivér admin-tilstand for at opdatere muskelkataloget");
    return;
  }
  const key = document.getElementById("muscleKey").value.trim().toLowerCase().replace(/[^a-z0-9_-]+/g, "_");
  const label = document.getElementById("muscleLabel").value.trim();
  if (!key) {
    alert("Key er påkrævet");
    return;
  }
  try {
    setStatus("Gemmer…");
    await upsertMuscle({ key, label });
    e.target.reset();
    await loadMuscles();
  } catch (err) {
    console.error(err);
    setStatus("Kunne ikke gemme ❌");
  }
});

document.getElementById("muscleRows").addEventListener("click", async (e) => {
  const action = e.target.dataset?.action;
  const key = e.target.dataset?.key;
  if (!action || !key) return;
  if (!isAdminMode()) {
    setStatus("Aktivér admin-tilstand for at redigere muskelgrupper");
    return;
  }
  if (action === "save") {
    const row = document.querySelector(`tr[data-key="${key}"]`);
    if (!row) return;
    const labelInput = row.querySelector('input[data-field="label"]');
    const label = labelInput?.value || "";
    try {
      setStatus("Gemmer…");
      await upsertMuscle({ key, label });
      await loadMuscles();
    } catch (err) {
      console.error(err);
      setStatus("Gemning fejlede ❌");
    }
  } else if (action === "delete") {
    if (!confirm(`Slet '${key}'?`)) return;
    try {
      setStatus("Sletter…");
      await deleteMuscle(key);
      await loadMuscles();
    } catch (err) {
      console.error(err);
      setStatus("Sletning fejlede ❌");
    }
  }
});

loadMuscles();
</script>

</body>
</html>
